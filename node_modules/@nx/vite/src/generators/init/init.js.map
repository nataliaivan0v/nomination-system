{"version":3,"sources":["../../../../../../packages/vite/src/generators/init/init.ts"],"sourcesContent":["import {\n  formatFiles,\n  GeneratorCallback,\n  readNxJson,\n  runTasksInSerial,\n  Tree,\n  updateNxJson,\n} from '@nx/devkit';\nimport { updatePackageScripts } from '@nx/devkit/src/utils/update-package-scripts';\n\nimport { createNodes } from '../../plugins/plugin';\nimport { InitGeneratorSchema } from './schema';\nimport {\n  addPlugin,\n  checkDependenciesInstalled,\n  moveToDevDependencies,\n} from './lib/utils';\n\nexport function updateNxJsonSettings(tree: Tree) {\n  const nxJson = readNxJson(tree);\n\n  const productionFileSet = nxJson.namedInputs?.production;\n  if (productionFileSet) {\n    productionFileSet.push(\n      '!{projectRoot}/**/?(*.)+(spec|test).[jt]s?(x)?(.snap)',\n      '!{projectRoot}/tsconfig.spec.json'\n    );\n\n    nxJson.namedInputs.production = Array.from(new Set(productionFileSet));\n  }\n\n  const hasPlugin = nxJson.plugins?.some((p) =>\n    typeof p === 'string'\n      ? p === '@nx/vite/plugin'\n      : p.plugin === '@nx/vite/plugin'\n  );\n\n  if (!hasPlugin) {\n    nxJson.targetDefaults ??= {};\n    nxJson.targetDefaults['@nx/vite:test'] ??= {};\n    nxJson.targetDefaults['@nx/vite:test'].cache ??= true;\n    nxJson.targetDefaults['@nx/vite:test'].inputs ??= [\n      'default',\n      productionFileSet ? '^production' : '^default',\n    ];\n  }\n\n  updateNxJson(tree, nxJson);\n}\n\nexport function initGenerator(tree: Tree, schema: InitGeneratorSchema) {\n  return initGeneratorInternal(tree, { addPlugin: false, ...schema });\n}\n\nexport async function initGeneratorInternal(\n  tree: Tree,\n  schema: InitGeneratorSchema\n) {\n  schema.addPlugin ??= process.env.NX_ADD_PLUGINS !== 'false';\n  if (schema.addPlugin) {\n    addPlugin(tree);\n  }\n\n  updateNxJsonSettings(tree);\n\n  const tasks: GeneratorCallback[] = [];\n  if (!schema.skipPackageJson) {\n    tasks.push(moveToDevDependencies(tree));\n    tasks.push(checkDependenciesInstalled(tree, schema));\n  }\n\n  if (schema.updatePackageScripts) {\n    await updatePackageScripts(tree, createNodes);\n  }\n\n  if (!schema.skipFormat) {\n    await formatFiles(tree);\n  }\n\n  return runTasksInSerial(...tasks);\n}\n\nexport default initGenerator;\n"],"names":["updateNxJsonSettings","initGenerator","initGeneratorInternal","tree","nxJson","readNxJson","productionFileSet","namedInputs","production","push","Array","from","Set","hasPlugin","plugins","some","p","plugin","targetDefaults","cache","inputs","updateNxJson","schema","addPlugin","process","env","NX_ADD_PLUGINS","tasks","skipPackageJson","moveToDevDependencies","checkDependenciesInstalled","updatePackageScripts","createNodes","skipFormat","formatFiles","runTasksInSerial"],"mappings":";;;;;;;;IAkBgBA,oBAAoB;eAApBA;;IAgCAC,aAAa;eAAbA;;IAIMC,qBAAqB;eAArBA;;IA4BtB,OAA6B;eAA7B;;;;wBA3EO;sCAC8B;wBAET;uBAMrB;AAEA,SAASF,qBAAqBG,IAAU;QAGnBC,qBAURA;IAZlB,MAAMA,SAASC,IAAAA,kBAAU,EAACF;IAE1B,MAAMG,qBAAoBF,sBAAAA,OAAOG,WAAW,qBAAlBH,oBAAoBI,UAAU;IACxD,IAAIF,mBAAmB;QACrBA,kBAAkBG,IAAI,CACpB,yDACA;QAGFL,OAAOG,WAAW,CAACC,UAAU,GAAGE,MAAMC,IAAI,CAAC,IAAIC,IAAIN;IACrD;IAEA,MAAMO,aAAYT,kBAAAA,OAAOU,OAAO,qBAAdV,gBAAgBW,IAAI,CAAC,CAACC,IACtC,OAAOA,MAAM,WACTA,MAAM,oBACNA,EAAEC,MAAM,KAAK;IAGnB,IAAI,CAACJ,WAAW;YACdT,SACAA,wBAAsB,aACtBA,mCACAA;;QAHAA,oBAAAA,UAAAA,QAAOc,4CAAPd,QAAOc,iBAAmB,CAAC;;QAC3Bd,MAAAA,yBAAAA,OAAOc,cAAc,CAAA,CAAC,cAAA,gBAAgB,gBAAtCd,sBAAqB,CAAC,YAAgB,GAAK,CAAC;;QAC5CA,WAAAA,oCAAAA,OAAOc,cAAc,CAAC,gBAAgB,EAACC,0BAAvCf,kCAAuCe,QAAU;;QACjDf,YAAAA,qCAAAA,OAAOc,cAAc,CAAC,gBAAgB,EAACE,4BAAvChB,mCAAuCgB,SAAW;YAChD;YACAd,oBAAoB,gBAAgB;SACrC;IACH;IAEAe,IAAAA,oBAAY,EAAClB,MAAMC;AACrB;AAEO,SAASH,cAAcE,IAAU,EAAEmB,MAA2B;IACnE,OAAOpB,sBAAsBC,MAAM;QAAEoB,WAAW;OAAUD;AAC5D;AAEO,eAAepB,sBACpBC,IAAU,EACVmB,MAA2B;QAE3BA;;IAAAA,eAAAA,UAAAA,QAAOC,kCAAPD,QAAOC,YAAcC,QAAQC,GAAG,CAACC,cAAc,KAAK;IACpD,IAAIJ,OAAOC,SAAS,EAAE;QACpBA,IAAAA,gBAAS,EAACpB;IACZ;IAEAH,qBAAqBG;IAErB,MAAMwB,QAA6B,EAAE;IACrC,IAAI,CAACL,OAAOM,eAAe,EAAE;QAC3BD,MAAMlB,IAAI,CAACoB,IAAAA,4BAAqB,EAAC1B;QACjCwB,MAAMlB,IAAI,CAACqB,IAAAA,iCAA0B,EAAC3B,MAAMmB;IAC9C;IAEA,IAAIA,OAAOS,oBAAoB,EAAE;QAC/B,MAAMA,IAAAA,0CAAoB,EAAC5B,MAAM6B,mBAAW;IAC9C;IAEA,IAAI,CAACV,OAAOW,UAAU,EAAE;QACtB,MAAMC,IAAAA,mBAAW,EAAC/B;IACpB;IAEA,OAAOgC,IAAAA,wBAAgB,KAAIR;AAC7B;MAEA,WAAe1B"}